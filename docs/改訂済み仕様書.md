# 支出記録アプリ（Expense Tracker）仕様書

**版数**: v2.0  
**日付**: 2025年1月27日  
**変更履歴**: 初版作成（v1.3からの全面改訂）

## 目次

1. [概要](#1-概要)
2. [目的](#2-目的)
3. [用語](#3-用語)
4. [前提](#4-前提)
5. [機能要件](#5-機能要件)
6. [非機能要件](#6-非機能要件)
7. [画面仕様](#7-画面仕様)
8. [データ仕様](#8-データ仕様)
9. [ユースケース](#9-ユースケース)
10. [エラー&境界条件](#10-エラー境界条件)
11. [アクセシビリティ](#11-アクセシビリティ)
12. [国際化](#12-国際化)
13. [パフォーマンス](#13-パフォーマンス)
14. [セキュリティ](#14-セキュリティ)
15. [テスト計画](#15-テスト計画)
16. [運用](#16-運用)
17. [リスク&未決](#17-リスク未決)
18. [将来拡張](#18-将来拡張)
19. [変更履歴](#19-変更履歴)

---

## 1. 概要

支出記録アプリは、個人の日々の支出を簡単に記録・管理できるWebアプリケーションです。ユーザーは支出の金額、カテゴリ、日付、メモを入力し、一覧表示や合計金額の確認、データの編集・削除が可能です。ブラウザのlocalStorageを使用してデータを保存するため、ネット接続なしでも基本操作が可能です。

**技術的特徴**:
- 初期ロード目標: 200KB gzipped以下の軽量設計
- 複数タブ対応: storage イベントによる自動同期
- 耐障害性: 自動バックアップと復旧機能
- アクセシビリティ: WCAG 2.1 AA準拠

## 2. 目的

- 日々の支出を手軽に記録し、金銭管理の習慣を身につける
- カテゴリ別に支出を分類し、支出傾向を可視化する
- 過去の支出履歴を簡単に確認・検索できるようにする
- オフラインでも利用可能な軽量アプリケーションを提供する

## 3. 用語

| 用語 | 定義 |
|------|------|
| 支出データ | 金額、カテゴリ、日付、メモを含む1件の支出記録 |
| カテゴリID | カテゴリを識別する英数字識別子（例: "food", "transport"） |
| カテゴリ名 | ユーザーに表示される日本語名称（例: "食費", "交通費"） |
| localStorage | ブラウザのローカルストレージ機能 |
| バリデーション | 入力データの妥当性チェック |
| トースト通知 | 画面に一時的に表示される通知メッセージ |
| フィルター | 支出データを条件で絞り込む機能 |
| ソート | 支出データを特定の順序で並べる機能 |
| UUID | 一意性を保証する識別子形式 |

## 4. 前提

### 4.1 技術的前提
- モダンブラウザ対応（Chrome、Firefox、Safari、Edge最新版）
- JavaScript ES6+対応
- localStorage利用可能
- インターネット接続不要（オフライン動作）

### 4.2 ユーザー前提
- 基本的なWebブラウザ操作が可能
- 日本語での入力・表示
- キーボード・マウス操作が可能

### 4.3 データ前提
- 個人利用を想定（複数ユーザー対応なし）
- データはブラウザローカルのみ保存
- 最大想定データ件数: 10,000件

## 5. 機能要件

### 5.1 基本機能

#### F-01: 支出の追加
**機能概要**: 入力フォームから支出データを追加する

**受け入れ基準（AC）**:
- 必須項目（金額、カテゴリ、日付）が入力されている
- 金額は1円以上9,999,999円以下の整数
- 日付は今日以前
- メモは100文字以内
- 追加成功時にトースト通知表示
- フォームがリセットされる

**詳細仕様**:
- 入力値のバリデーション実行
- localStorageへの保存
- リストへの即時反映
- フォームのリセット

#### F-02: 支出の一覧表示
**機能概要**: 保存された全支出データを表示する

**受け入れ基準（AC）**:
- 全支出データが日付降順で表示
- カテゴリアイコンが正しく表示
- 合計金額が正確に計算される
- 0件時は「最初の支出を追加しましょう」メッセージ表示

**詳細仕様**:
- 日付降順でのデフォルト表示
- カテゴリ別アイコン表示
- データが0件の場合のメッセージ表示

#### F-03: 支出の編集
**機能概要**: 既存の支出データを編集する

**受け入れ基準（AC）**:
- 編集ボタンクリックでフォームにデータ読み込み
- 更新時にバリデーション実行
- 更新成功時にトースト通知表示
- リストが即座に更新される

**詳細仕様**:
- 編集ボタンクリックで該当データをフォームに読み込み
- データ更新後の保存
- リストの再描画

#### F-04: 支出の削除
**機能概要**: 支出データを削除する（Undo機能付き）

**受け入れ基準（AC）**:
- 削除ボタンクリックで即座に削除
- 5秒間「取り消し」ボタン付きトースト表示
- 取り消しでデータ復元
- リストが即座に更新される

**詳細仕様**:
- 削除ボタンクリックで即座に削除実行（確認ダイアログなし）
- 削除後、5秒間「取り消し」ボタン付きトースト通知を表示
- 「取り消し」クリックでバックアップから復元
- バックアップは削除前に自動作成

#### F-05: 合計金額の計算・表示
**機能概要**: 支出の合計金額を計算・表示する

**受け入れ基準（AC）**:
- 全支出の合計が正確に計算される
- フィルター適用時は絞り込み後の合計も表示
- リアルタイムで更新される

**詳細仕様**:
- 全支出の合計金額をリアルタイム計算
- ヘッダーに常時表示
- フィルター適用時は絞り込み後の合計も表示

### 5.2 拡張機能

#### F-06: フィルター機能
**機能概要**: 支出データを条件で絞り込む

**受け入れ基準（AC）**:
- カテゴリフィルターが正しく動作
- 期間フィルター（今月/先月/カスタム）が正しく動作
- 検索機能（メモ・カテゴリ名）が部分一致で動作
- フィルター設定がlocalStorageに保存される

**詳細仕様**:
- カテゴリ別フィルタリング（すべて/特定カテゴリ選択）
- 期間別フィルタリング（すべて/今月/先月/カスタム）
- 検索機能（メモ内容・カテゴリ名の部分一致検索）
- フィルター適用後の件数・合計金額表示
- 300msデバウンス処理でパフォーマンス最適化
- 設定の永続化

#### F-07: ソート機能
**機能概要**: 支出データを特定の順序で並べる

**受け入れ基準（AC）**:
- 日付順（昇順/降順）ソートが正しく動作
- 金額順（昇順/降順）ソートが正しく動作
- カテゴリ順ソートが正しく動作
- ソート設定がlocalStorageに保存される

**詳細仕様**:
- 日付順（昇順/降順）
- 金額順（昇順/降順）
- カテゴリ順（カテゴリマスタ定義順）
- 安定ソート（同一キー時はcreatedAt降順）
- ソート方向インジケータ表示
- 設定の永続化

#### F-08: データ管理機能
**機能概要**: データの一括操作とエクスポート機能

**受け入れ基準（AC）**:
- 全削除時に確認ダイアログ表示
- CSVエクスポートで正しい形式でダウンロード
- ファイル名に日付が含まれる
- UTF-8 with BOM形式で出力

**詳細仕様**:
- 全データ削除（確認ダイアログ付き）
- CSVエクスポート機能
- データのバックアップ機能

## 6. 非機能要件

### 6.1 パフォーマンス要件
- 初期ロード時間: 200KB gzipped以下
- UI反映時間: 1操作あたり50ms以内
- 大量データ対応: 1,000件超で仮想スクロール有効化
- フィルター/ソート: 300msデバウンス処理

### 6.2 可用性要件
- オフライン動作: インターネット接続不要
- ブラウザ対応: Chrome、Firefox、Safari、Edge最新版
- データ永続化: localStorage使用

### 6.3 セキュリティ要件
- XSS対策: ユーザー入力値の適切なエスケープ
- 入力値バリデーション: クライアント側で厳密に実施
- データ保護: ローカルストレージのみ使用

## 7. 画面仕様

### 7.1 ワイヤ概要

アプリは1つのHTMLページで構成され、以下のセクションで構成されます。

```
┌─────────────────────────────────────┐
│ ヘッダー部                          │
│ - アプリタイトル                    │
│ - 総支出額表示                      │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ 入力フォーム部                      │
│ - 金額入力欄（必須）                │
│ - カテゴリ選択欄（必須）            │
│ - 日付入力欄（必須）                │
│ - 日付ショートカットボタン          │
│ - メモ入力欄（任意）                │
│ - 追加ボタン                        │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ フィルター・ソート部                │
│ - カテゴリフィルター                │
│ - 期間フィルター                    │
│ - 検索ボックス                      │
│ - ソート順選択                      │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ 支出リスト部                        │
│ - 支出データ一覧                    │
│ - 編集・削除ボタン                  │
│ - 合計金額表示                      │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ フッター部                          │
│ - データ全削除ボタン                │
│ - CSVエクスポートボタン               │
└─────────────────────────────────────┘
```

### 7.2 UI要素表

| 要素名 | 型 | 必須 | バリデーション | エラー表示 | 操作 |
|--------|----|----|--------------|-----------|------|
| 金額入力欄 | input[type="number"] | ○ | 1円以上9,999,999円以下、整数 | フィールド直下に赤文字 | 全角→半角自動変換、カンマ除去 |
| カテゴリ選択欄 | select | ○ | 有効なカテゴリID | フィールド直下に赤文字 | ドロップダウン選択 |
| 日付入力欄 | input[type="date"] | ○ | 今日以前の日付 | フィールド直下に赤文字 | 日付ピッカー表示 |
| 日付ショートカット | button | - | - | - | 今日/昨日/先週末ボタン |
| メモ入力欄 | textarea | - | 100文字以内 | フィールド直下に赤文字 | リアルタイム文字数カウント |
| 追加ボタン | button | - | 全必須項目入力済み | - | フォーム送信 |
| カテゴリフィルター | select | - | - | - | ドロップダウン選択 |
| 期間フィルター | select | - | - | - | ドロップダウン選択 |
| 検索ボックス | input[type="text"] | - | - | - | リアルタイム検索 |
| ソート順選択 | select | - | - | - | ドロップダウン選択 |
| 編集ボタン | button | - | - | - | 編集フォーム表示 |
| 削除ボタン | button | - | - | - | 即座に削除実行 |
| 全削除ボタン | button | - | - | - | 確認ダイアログ表示 |
| CSVエクスポートボタン | button | - | - | - | CSVファイルダウンロード |

## 8. データ仕様

### 8.1 ストレージキー

localStorageキーを`expense.v1`に統一し、以下の構造で管理します。

```javascript
// メインデータ
"expense.v1" : {
  "expenses": [],           // 支出データ配列
  "settings": {            // 設定データ
    "filters": {},         // フィルター設定
    "sort": {}             // ソート設定
  },
  "schemaVersion": "1.0",  // スキーマバージョン
  "backup": []             // バックアップデータ
}
```

### 8.2 支出データスキーマ

| フィールド | 型 | 制約 | 例 |
|-----------|----|----|-----|
| id | string | UUID v4形式 | "550e8400-e29b-41d4-a716-446655440000" |
| amount | number | 1円以上9,999,999円以下 | 1200 |
| category | string | カテゴリID | "food" |
| date | string | YYYY-MM-DD形式 | "2025-01-27" |
| memo | string | 最大100文字 | "ランチ" |
| createdAt | string | ISO 8601形式（UTC） | "2025-01-27T03:30:00.000Z" |
| updatedAt | string | ISO 8601形式（UTC） | "2025-01-27T03:30:00.000Z" |

### 8.3 カテゴリマスタ

| カテゴリID | 日本語名 | アイコン | 色 | 順序 |
|-----------|---------|---------|-----|------|
| food | 食費 | 🍽️ | #FF6B6B | 1 |
| transport | 交通費 | 🚗 | #4ECDC4 | 2 |
| entertainment | 娯楽 | 🎮 | #95E1D3 | 3 |
| utilities | 光熱費 | 💡 | #FFE66D | 4 |
| other | その他 | 📦 | #A8DADC | 5 |

### 8.4 日付・通貨フォーマット

**日付フォーマット**:
- 入力: YYYY-MM-DD形式
- 表示: `Intl.DateTimeFormat('ja-JP', { timeZone: 'Asia/Tokyo' })`を使用
- 例: "2025年1月27日"

**通貨フォーマット**:
- 表示: `Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' })`を使用
- 例: "¥1,200"

## 9. ユースケース

### UC-01: 支出の記録
**アクター**: ユーザー  
**前提条件**: アプリが起動している  
**基本フロー**:
1. ユーザーが金額を入力
2. ユーザーがカテゴリを選択
3. ユーザーが日付を入力（デフォルト: 今日）
4. ユーザーがメモを入力（任意）
5. ユーザーが「追加」ボタンをクリック
6. システムがバリデーションを実行
7. システムがデータを保存
8. システムがリストを更新
9. システムがトースト通知を表示

**代替フロー**:
- 7a. バリデーションエラー時: エラーメッセージを表示し、入力フォームに戻る

### UC-02: 支出の検索
**アクター**: ユーザー  
**前提条件**: 支出データが存在する  
**基本フロー**:
1. ユーザーが検索ボックスにキーワードを入力
2. システムがリアルタイムで検索を実行
3. システムが検索結果を表示
4. ユーザーが該当する支出を確認

### UC-03: 支出の編集
**アクター**: ユーザー  
**前提条件**: 支出データが存在する  
**基本フロー**:
1. ユーザーが編集ボタンをクリック
2. システムがフォームにデータを読み込み
3. ユーザーがデータを修正
4. ユーザーが「更新」ボタンをクリック
5. システムがバリデーションを実行
6. システムがデータを更新
7. システムがリストを更新
8. システムがトースト通知を表示

### UC-04: 支出の削除
**アクター**: ユーザー  
**前提条件**: 支出データが存在する  
**基本フロー**:
1. ユーザーが削除ボタンをクリック
2. システムがデータを削除
3. システムがリストを更新
4. システムが「取り消し」ボタン付きトースト通知を表示
5. ユーザーが「取り消し」をクリック（5秒以内）
6. システムがデータを復元
7. システムがリストを更新

## 10. エラー&境界条件

### 10.1 入力エラー

| エラー条件 | エラーメッセージ | 表示場所 |
|-----------|-----------------|---------|
| 金額が0円以下 | "金額は1円以上9,999,999円以下の整数で入力してください" | 金額入力欄直下 |
| 金額が9,999,999円超過 | "金額は1円以上9,999,999円以下の整数で入力してください" | 金額入力欄直下 |
| 金額が小数 | "金額は整数で入力してください" | 金額入力欄直下 |
| 未来日入力 | "未来日は登録できません" | 日付入力欄直下 |
| メモ100文字超過 | "メモは100文字以内で入力してください（現在：○○文字）" | メモ入力欄直下 |
| 必須項目未入力 | "必須項目を入力してください" | 該当フィールド直下 |

### 10.2 システムエラー

| エラー条件 | エラーメッセージ | 対応 |
|-----------|-----------------|------|
| localStorage容量超過 | "ストレージ容量が不足しています" | CSVエクスポート提案 |
| localStorage利用不可 | "ストレージが利用できません（プライベートブラウジングモード等）" | エラー画面表示 |
| データ破損 | "データが破損しています" | バックアップ復元提案 |
| ネットワークエラー | "ネットワークエラーが発生しました" | 再試行ボタン表示 |

### 10.3 境界条件

| 条件 | 想定値 | 対応 |
|------|--------|------|
| 0円入力 | 0 | エラー表示、保存拒否 |
| 未来日入力 | 明日以降 | エラー表示、保存拒否 |
| 1万件データ | 10,000件 | 仮想スクロール有効化 |
| 長文メモ | 100文字 | 文字数制限、エラー表示 |
| カテゴリ未設定 | 未選択 | デフォルト値設定 |
| 同時二重入力 | 複数タブ | 競合検知、解決ダイアログ |

## 11. アクセシビリティ

### 11.1 WCAG 2.1 AA準拠

**コントラスト比**:
- 通常テキスト: 4.5:1以上
- 大きなテキスト: 3:1以上

**キーボード操作**:
- Tab: 論理的なフォーカス順序で移動
- Enter: フォーカスがフォーム内の時のみ登録実行
- Escape: モーダル・ダイアログを閉じる
- `/`: 検索フィールドにフォーカス（オプション）

**スクリーンリーダー対応**:
- 適切なARIA属性（`aria-label`, `aria-labelledby`, `aria-describedby`, `aria-invalid`, `aria-live`, `role`）
- すべての操作ボタンに`aria-label`を付与
- 読み上げ順序の最適化
- フォーカスインジケータの視認性確保

## 12. 国際化

### 12.1 現行要件

**日付フォーマット**:
- `Intl.DateTimeFormat('ja-JP', { timeZone: 'Asia/Tokyo' })`を使用
- タイムゾーン: Asia/Tokyo

**通貨フォーマット**:
- `Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' })`を使用
- 通貨: 日本円（JPY）

**文字エンコーディング**:
- UTF-8
- CSV出力時: UTF-8 with BOM（Excel互換）

### 12.2 将来対応

**多言語対応**:
- カテゴリIDは言語非依存で保持
- UI文言を言語ファイルに分離
- ブラウザの言語設定に基づいて言語を切り替え

## 13. パフォーマンス

### 13.1 初期ロード

**目標**:
- 初期ロード: 200KB gzipped以下
- 段階的ロード戦略を採用

**最適化手法**:
- コード分割（Code Splitting）
- 遅延ロード（Lazy Loading）
- 最小限の依存関係

### 13.2 大量データ対応

**1,000件超の場合**:
- 仮想スクロール（Virtual Scroll）を有効化
- ページネーション併用（50件/ページ）

**UI反映時間**:
- 1操作あたり50ms以内でUI反映
- フィルター/ソート: 300msデバウンス処理

### 13.3 メモリ使用量

**想定容量**:
- 5MB想定（localStorage制限）
- データ圧縮による容量削減

## 14. セキュリティ

### 14.1 XSS対策

**入力値の適切なエスケープ**:
- ユーザー入力値を表示する際は常に`textContent`を使用
- `innerHTML`は回避
- URL自動リンク機能は無効化

### 14.2 入力値バリデーション

**クライアント側バリデーション**:
- リアルタイムフィードバックでUX向上
- 入力正規化（全角→半角、カンマ除去）
- エラー表示（各フィールド直下）

### 14.3 データ保護

**ローカルストレージのみ使用**:
- サーバーへのデータ送信なし
- プライベートブラウジングモード対応
- データ暗号化は不要（ローカル利用のみ）

## 15. テスト計画

### 15.1 単体テスト

**対象**:
- バリデーション関数
- データ操作関数
- ユーティリティ関数

**ツール**:
- Jest
- カバレッジ目標: 80%以上

### 15.2 結合テスト

**対象**:
- フォーム送信フロー
- フィルター・ソート機能
- データ永続化

**ツール**:
- Jest
- モック使用

### 15.3 E2Eテスト

**対象**:
- 主要ユースケース
- ブラウザ間互換性
- レスポンシブデザイン

**ツール**:
- Playwright
- Chrome、Firefox、Safari、Edge

### 15.4 パフォーマンステスト

**対象**:
- 初期ロード時間
- 大量データ処理
- メモリ使用量

**ツール**:
- Lighthouse
- Chrome DevTools

## 16. 運用

### 16.1 ブラウザ対応

**対応ブラウザ**:
- Chrome 最新版
- Firefox 最新版
- Safari 最新版
- Edge 最新版

**モバイル対応**:
- iOS Safari
- Chrome Mobile

### 16.2 データバックアップ

**自動バックアップ**:
- データ変更時に自動実行
- 直近1世代を保持
- 復元機能付き

**手動バックアップ**:
- CSVエクスポート機能
- データ移行支援

### 16.3 エラー監視

**監視対象**:
- localStorageエラー
- バリデーションエラー
- パフォーマンス問題

**対応**:
- エラーログ出力
- ユーザーへの適切なエラー表示

## 17. リスク&未決

### 17.1 技術的リスク

| リスク | 影響度 | 発生確率 | 対応策 |
|--------|--------|---------|--------|
| localStorage容量超過 | 高 | 中 | CSVエクスポート機能、データ圧縮 |
| ブラウザ互換性問題 | 中 | 低 | ポリフィル使用、テスト強化 |
| パフォーマンス問題 | 中 | 中 | 仮想スクロール、ページネーション |
| データ破損 | 高 | 低 | 自動バックアップ、復元機能 |

### 17.2 未決事項

| 事項 | 検討内容 | 決定期限 |
|------|---------|---------|
| 多言語対応 | 対応言語、実装方法 | v2.0 |
| クラウド同期 | 技術選定、実装方法 | v3.0 |
| PWA化 | 実装範囲、配信方法 | v2.5 |
| データ可視化 | ライブラリ選定、実装方法 | v3.0 |

## 18. 将来拡張

### 18.1 短期拡張（v2.0）

**CSV入出力**:
- CSVインポート機能
- データ移行支援
- 他アプリとの連携

**PWA化**:
- オフライン動作強化
- アプリインストール対応
- プッシュ通知

### 18.2 中期拡張（v3.0）

**クラウド同期**:
- Firebase Realtime Database
- 複数デバイス同期
- 競合解決機能

**データ可視化**:
- 月次・年次レポート
- カテゴリ別支出グラフ
- 時系列分析

### 18.3 長期拡張（v4.0以降）

**AI機能**:
- 支出予測
- カテゴリ自動分類
- 異常支出検知

**API化**:
- REST API提供
- 他アプリとの連携
- データ分析機能

## 19. 変更履歴

| 版数 | 日付 | 変更内容 |
|------|------|---------|
| v2.0 | 2025-01-27 | 初版作成（v1.3からの全面改訂）<br>- 章立ての標準化<br>- 受け入れ基準（AC）の明記<br>- エラー&境界条件の追加<br>- テスト計画の追加<br>- リスク&未決事項の追加<br>- 将来拡張計画の追加<br>- 画面仕様のUI要素表追加<br>- データ仕様のlocalStorageキー統一<br>- パフォーマンス目標の現実化 |

---

## 変更差分サマリ（Before→After）

**Before**: 技術的詳細に偏った仕様書、曖昧な表現、抜けている要件、非現実的な目標  
**After**: 要件定義者向けの明確な仕様書、具体的な受け入れ基準、網羅的なエラー処理、現実的なパフォーマンス目標  
**Before**: 章立てが不統一、テスト計画なし、リスク管理なし  
**After**: 標準的な章立て、詳細なテスト計画、リスク&未決事項の明記  
**Before**: 画面仕様がワイヤのみ、データ仕様が複雑  
**After**: UI要素表追加、localStorageキー統一、データ構造明確化  
**Before**: 将来拡張が技術的詳細のみ  
**After**: 段階的な拡張計画、具体的な実装方針、技術選定の検討事項
